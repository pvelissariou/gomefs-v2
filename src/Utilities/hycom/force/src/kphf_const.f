      PROGRAM KPHF_CONST
      USE MOD_ZA  ! HYCOM array I/O interface
      IMPLICIT NONE
C
C     FLUX ARRAYS.
C
      INTEGER, ALLOCATABLE :: MSK(:,:)
      REAL*4,  ALLOCATABLE :: PLON(:,:),PLAT(:,:),XAF(:,:),YAF(:,:)
      REAL*4,  ALLOCATABLE :: FLD(:,:)
C
      CHARACTER PREAMBL(5)*79
C
C     NAMELIST.
C
      INTEGER          JPR
      COMMON/NPROCS/   JPR
      SAVE  /NPROCS/
C
      CHARACTER*40     CTITLE
      CHARACTER*8      CNAME
      NAMELIST/AFTITL/ CTITLE,CNAME
      REAL*4           FMON(12)
      REAL*8           FINC,FSTART,WSTART,TSTART,TMAX
      NAMELIST/AFTIME/ FINC,FSTART,WSTART,TSTART,TMAX
      NAMELIST/AFCNST/ FMON
C
C**********
C*
C 1)  FROM A SEQUENCE OF MONTHLY kPAR VALUES, CREATE A
C      CONSTANT FIELD MODEL GRID FILE SUITABLE FOR INPUT
C      TO THE HYCOM OCEAN MODEL OVER THE GIVEN REGION.
C
C     kPAR is the attenuation length scale of photosynthetically
C     available radiation (PAR), typically based on k490 from SeaWiFS.
C     Rochford P.A., A.B. Kara, A.J. Wallcraft and R.A. Arnone, 2001:
C     Importance of solar subsurface heating in ocean general
C     circulation models.  J. Geophys. Res., 106, 30923-30938.
C
C     THIS PROGRAM CAN BE USED FOR ANY SINGLE FIELD BY SPECIFYING CNAME.
C
C 2)  PARAMETERS:
C
C     MODEL GRID SPECIFICATION (W.R.T. PRESSURE GRID):
C
C        IDM    = 1ST DIMENSION OF MAJOR (HYCOM) MODEL ARRAYS
C        JDM    = 2ND DIMENSION OF MAJOR (HYCOM) MODEL ARRAYS
C
C 3)  NAMELIST INPUT:
C
C     /AFTITL/
C        CTITLE - ONE (40-CHARACTER) LINE TITLE.
C        CNAME  - ONE  (8-CHARACTER) LINE NAME (default "    kpar").
C
C     /AFTIME/
C        FINC   - TIME INCREMENT BETWEEN OUTPUT FLUXES     (DAYS)
C        FSTART - TIME OF HEAT FLUX START                  (DAYS)
C        WSTART - TIME OF WIND START, IGNORED HERE         (DAYS)
C        TMAX   - TIME OF END   OF CURRENT INTEGRATION     (DAYS)
C        TSTART - TIME OF START OF CURRENT INTEGRATION     (DAYS)
C
C     /AFCNST/
C        FMON   - MONTHY FIELD (KPAR) VALUES
C
C     NAMELIST /AFTIME/ IS PATTERNED AFTER /XXTIME/ SO THAT THE
C      MODEL''S STANDARD AWK-BASED RUN SCRIPT CUSTOMIZER CAN ALSO
C      WORK FOR THE FLUX GENERATION SCRIPT.  IN PARTICULAR, 'WSTART'
C      IS READ IN, BUT NOT USED.
C
C 4)  THE OUTPUT FIELDS HAVE THEIR COMPONENTS ON EVERY GRID POINT OF 
C      THE MODEL'S 'P' GRID.  ARRAY SIZE IS 'IDM' BY 'JDM, AND THE DATA
C      IS OUTPUT .a/.b FORMAT TOGETHER WITH day AND span.
C*
C**********
C
C
      INTEGER    MAXREC
      PARAMETER (MAXREC=90000)
C
      CHARACTER*80 CLINE
      INTEGER IFREC,IUREC,IWIX,NREC
      REAL*4  WDAY(MAXREC+1),FDY,WYR
C
      INTEGER K0,K1,K2,K3
      REAL*4  W0,W1,W2,W3
C
      INTEGER I,J,KREC
      REAL*4  XMIN,XMAX
C
C --- MODEL ARRAYS.
C
      CALL XCSPMD  !define idm,jdm
      ALLOCATE(  MSK(IDM,JDM) )
      ALLOCATE(  FLD(IDM,JDM) )
C
C     NAMELIST INPUT.
C
      CALL ZHOPEN(6, 'FORMATTED', 'UNKNOWN', 0)
C
      CTITLE = ' '
      CNAME  = '    kpar'
      WRITE(6,*) 'READING /AFTITL/'
      CALL ZHFLSH(6)
      READ( 5,AFTITL)
      WRITE(6,AFTITL)
C
      FSTART = 0.0
      WSTART = 0.0
      TSTART = 0.0
      TMAX   = 0.0
      WRITE(6,*) 'READING /AFTIME/'
      CALL ZHFLSH(6)
      READ( 5,AFTIME)
      WRITE(6,AFTIME)
      WRITE(6,*)
      CALL ZHFLSH(6)
      IF     (FINC.EQ.0.0) THEN
        WRITE(6,*) 'ERROR - FINC MUST BE POSITIVE'
        WRITE(6,*)
        CALL ZHFLSH(6)
        STOP
      ENDIF
C
      FMON(:) = 0.0
      WRITE(6,*) 'READING /AFCNST/'
      CALL ZHFLSH(6)
      READ( 5,AFCNST)
      WRITE(6,AFCNST)
      WRITE(6,*) 
      CALL ZHFLSH(6)
C
C     INITIALIZE HYCOM OUTPUT.
C
      CALL ZAIOST
      CALL ZAIOPN('NEW', 10)
C
      CALL ZHOPEN(10, 'FORMATTED', 'NEW', 0)
C
      PREAMBL(1) = CTITLE
      PREAMBL(2) = ' '
      PREAMBL(3) = ' '
      PREAMBL(4) = ' '
      WRITE(PREAMBL(5),'(A,2I5)')
     +        'i/jdm =',
     +       IDM,JDM
      WRITE(10,4101) PREAMBL
      WRITE(6,*)
      WRITE(6, 4101) PREAMBL
      WRITE(6,*)
C
C     PROCESS ALL THE FLUX RECORDS.
C
      NREC = NINT( (TMAX - TSTART) / FINC ) + 1
C
      WDAY(1) = FSTART
      DO 810 KREC= 1,NREC
C
C       SPECIFY THE FLUX DAY.
C
        WDAY(KREC+1) = FSTART + KREC*FINC
        CALL FCOEFS(K0,K1,K2,K3,W0,W1,W2,W3, WDAY(KREC))
C
C       CONSTANT FIELDS.
C
        DO J= 1,JDM
          DO I= 1,IDM
            FLD(I,J) = W0*FMON(K0) + W1*FMON(K1) +
     +                 W2*FMON(K2) + W3*FMON(K3)
          ENDDO
        ENDDO
C
C       WRITE OUT HYCOM FLUXS.
C
        CALL ZAIOWR(FLD,MSK,.FALSE., XMIN,XMAX, 10, .FALSE.)
        WRITE(10,4112) CNAME,WDAY(KREC),WDAY(KREC+1)-WDAY(KREC),
     +                 XMIN,XMAX
        CALL ZHFLSH(10)
C
        CALL WNDAY(WDAY(KREC), WYR,FDY)
        WRITE(6,6350) KREC,WDAY(KREC),FDY,NINT(WYR)
        CALL ZHFLSH(6)
  810 CONTINUE
C
      CALL ZAIOCL(10)
      CLOSE( UNIT=10)
      STOP
C
 4101 FORMAT(A79)
 4112 FORMAT(A,': day,span,range =',F12.5,F10.6,1P2E16.7)
 6350 FORMAT(10X,'WRITING RECORD',I5,
     +           '    FDAY =',F10.3,
     +            '  FDATE =',F8.3,'/',I4 /)
C     END OF PROGRAM KPHF_CONST.
      END
      SUBROUTINE WNDAY(WDAY, YEAR,DAY)
      IMPLICIT NONE
      REAL*4 WDAY,YEAR,DAY
C
C**********
C*
C  1) CONVERT 'WIND DAY' INTO JULIAN DAY AND YEAR.
C
C  2) THE 'WIND DAY' IS THE NUMBER OF DAYS SINCE 001/1901 (WHICH IS 
C      WIND DAY 1.0).
C     FOR EXAMPLE:
C      A) YEAR=1901.0 AND DAY=1.0, REPRESENTS 0000Z HRS ON 001/1901
C         SO WDAY WOULD BE 1.0.
C      B) YEAR=1901.0 AND DAY=2.5, REPRESENTS 1200Z HRS ON 002/1901
C         SO WDAY WOULD BE 2.5.
C     YEAR MUST BE NO LESS THAN 1901.0, AND NO GREATER THAN 2099.0.
C     NOTE THAT YEAR 2000 IS A LEAP YEAR (BUT 1900 AND 2100 ARE NOT).
C
C  3) ALAN J. WALLCRAFT, PLANNING SYSTEMS INC., FEBRUARY 1993.
C*
C**********
C
      INTEGER IYR,NLEAP
      REAL*4  WDAY1
C
C     FIND THE RIGHT YEAR.
C
      IYR   = (WDAY-1.0)/365.25
      NLEAP = IYR/4
      WDAY1 = 365.0*IYR + NLEAP + 1.0
      DAY   = WDAY - WDAY1 + 1.0
      IF     (WDAY1.GT.WDAY) THEN
        IYR   = IYR - 1
      ELSEIF (DAY.GE.367.0) THEN
        IYR   = IYR + 1
      ELSEIF (DAY.GE.366.0 .AND. MOD(IYR,4).NE.3) THEN
        IYR   = IYR + 1
      ENDIF
      NLEAP = IYR/4
      WDAY1 = 365.0*IYR + NLEAP + 1.0
C
C     RETURN YEAR AND JULIAN DAY.
C
      YEAR = 1901 + IYR
      DAY  = WDAY - WDAY1 + 1.0
      RETURN
C     END OF WNDAY.
      END
      SUBROUTINE FCOEFS(K0,K1,K2,K3,W0,W1,W2,W3, FDAY)
      IMPLICIT NONE
C
      INTEGER K0,K1,K2,K3
      REAL*4  W0,W1,W2,W3, FDAY
C
C     FIND THE MONTHLY INTERPOLATION COEFFICENTS FOR A GIVEN FLUX DAY.
C
      REAL*4     ONE,TWELVE,FIFTEEN
      PARAMETER (ONE=1.0, TWELVE=12.0, FIFTEEN=15.0)
C
      REAL*4 FYR,FDY,YEAR,X,X1
C
      CALL WNDAY(FDAY, FYR,FDY)
      IF     (MOD(NINT(FYR),4).EQ.0) THEN
        YEAR = 366.0
      ELSE
        YEAR = 365.0
      ENDIF
C
      X  = 1.0+MOD(FDY+YEAR-FIFTEEN,YEAR)/(YEAR/TWELVE)
      K1 = X
      K0 = MOD(K1+10,12)+1
      K2 = MOD(K1,   12)+1
      K3 = MOD(K2,   12)+1
C
      X  = MOD(X,ONE)
      X1 = 1.-X
      W1 = X1*(1.+X *(1.-1.5*X ))
      W2 = X *(1.+X1*(1.-1.5*X1))
      W0 = -.5*X *X1*X1
      W3 = -.5*X1*X *X
C
*     WRITE(6,6000) FDAY,FDY,K0,K1,K2,K3,W0,W1,W2,W3
*     CALL ZHFLSH(6)
      RETURN
 6000 FORMAT('FCOEFS:',F9.2,F7.2,4I3,4F7.3)
      END
